<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html; charset=utf-8" />
    <title>Rototype test</title>
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </head>

<body>
	<table>
    <caption>Commands</caption>
    <tr>
      <th scope="col">Main</th>
      <th scope="col">Barcode</th>
      <th scope="col">NFC</th>
      <th scope="col">Ticket printer</th>
      <th scope="col">Receipt printer</th>
      <th scope="col">Lights</th>
    </tr>
		<tr>
			<td>
				<button id="btn-connect" type="button">Connect</button><br><br>
				<button id="btn-disconnect" type="button">Disconnect</button><br><br>
				<button id="btn-get-services" type="button">Get Services</button><br><br>
				<button id="btn-clear-log" type="button">Clear log</button>
			</td>
			<td>
				<button id="btn-barcode-reset" type="button">Barcode reset</button><br><br>
				<button id="btn-barcode-read" type="button">Barcode read</button><br><br>
				<button id="btn-barcode-test" type="button">Barcode test</button>

				<table>
          <caption>Barcode</caption>
          <tr>
            <th scope="col">Device status</th>
            <th scope="col">Scanner status</th>
            <th scope="col">Last read</th>
          </tr>
					<tr>
						<td>Device status:</td>
						<td id="barcode-device-status"></td>
					</tr>
					<tr>
						<td>Scanner status:</td>
						<td id="barcode-scanner-status"></td>
					</tr>
					<tr>
						<td>Last read:</td>
						<td id="barcode-last-read"></td>
					</tr>
				</table>
			</td>
			<td>
				<button id="btn-nfc-reset" type="button">RFID reset</button><br><br>
				<button id="btn-nfc-read" type="button">RFID read</button><br><br>
				<button id="btn-nfc-test" type="button">RFID test</button>

				<table>
          <caption>NFC</caption>
          <tr>
            <th scope="col">Device status</th>
            <th scope="col">Scanner status</th>
            <th scope="col">Last read</th>
          </tr>
					<tr>
						<td>Device status:</td>
						<td id="nfc-device-status"></td>
					</tr>
					<tr>
						<td>Scanner status:</td>
						<td id="nfc-scanner-status"></td>
					</tr>
					<tr>
						<td>Last read:</td>
						<td id="nfc-last-read"></td>
					</tr>
				</table>
			</td>
			<td>
				<button id="btn-tck-reset" type="button">TCK reset</button><br><br>
				<button id="btn-tck-print-raw" type="button">TCK print raw</button><br><br>
				<button id="btn-tck-test" type="button">TCK test</button>

				<table>
          <caption>Ticket printer</caption>
          <tr>
            <th scope="col">Printer status</th>
            <th scope="col">Paper status</th>
            <th scope="col">Last print</th>
          </tr>
					<tr>
						<td>Printer status:</td>
						<td id="tck-status"></td>
					</tr>
					<tr>
						<td>Paper status:</td>
						<td id="tck-paper-status"></td>
					</tr>
					<tr>
						<td>Last print result:</td>
						<td id="tck-last-print"></td>
					</tr>
				</table>
			</td>
			<td>
				<button id="btn-receipt-reset" type="button">Receipt reset</button><br><br>
				<button id="btn-receipt-print" type="button">Receipt print</button><br><br>
				<button id="btn-receipt-load-def" type="button">Receipt load definition</button>

				<table>
          <caption>Receipt printer</caption>
          <tr>
            <th scope="col">Printer status</th>
            <th scope="col">Paper status</th>
            <th scope="col">Last print</th>
          </tr>
					<tr>
						<td>Printer status:</td>
						<td id="receipt-status"></td>
					</tr>
					<tr>
						<td>Paper status:</td>
						<td id="receipt-paper-status"></td>
					</tr>
					<tr>
						<td>Last print result:</td>
						<td id="receipt-last-print"></td>
					</tr>
				</table>
			</td>
			<td>
				<button id="btn-lights-set" type="button">Lights set</button><br><br>
				<button id="btn-lights-off" type="button">Lights off</button><br><br>

				<table>
          <caption>Lights</caption>
          <tr>
            <th scope="col">Lights status</th>
          </tr>
					<tr>
						<td>Lights status:</td>
						<td id="lights-status"></td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<pre style="height: 75%; overflow: auto; border-style: double;" id="log"></pre>

	<script type="module">
		import { Rototype } from './rototype.js';

		$(document).ready(function () {
			$("#btn-connect").click(doConnect);
			$("#btn-disconnect").click(doDisconnect);
			$("#btn-get-services").click(doGetServices);
			$("#btn-clear-log").click(doClearLog);
			$("#btn-barcode-reset").click(doBarcodeReset);
			$("#btn-barcode-read").click(doBarcodeRead);
			$("#btn-barcode-test").click(doBarcodeTest);
			$("#btn-nfc-reset").click(doNFCReset);
			$("#btn-nfc-read").click(doNFCRead);
			$("#btn-nfc-test").click(doNFCTest);
			$("#btn-tck-reset").click(doTckReset);
			$("#btn-tck-print-raw").click(doTckPrintRaw);
			$("#btn-tck-test").click(doTckTest);
			$("#btn-receipt-reset").click(doReceiptReset);
			$("#btn-receipt-print").click(doReceiptPrintForm);
			$("#btn-receipt-load-def").click(doReceiptLoadDef);
			$("#btn-lights-set").click(doLightsSet);
			$("#btn-lights-off").click(doLightsOff);
		});

		var rototype;

		function onServicesChanged(services) {
			console.log("I see new services");
			services.forEach((service) => {
				console.log(service.serviceDescr);
			});
		}

		function doConnect() {
			rototype = new Rototype();
			rototype.onServicesChanged = onServicesChanged;
			rototype.onBarcodeStatusChanged = onBarcodeStatusChanged;
			rototype.onBarcodeRead = onBarcodeRead;
			rototype.onNFCStatusChanged = onNFCStatusChanged;
			rototype.onNfcRead = onNfcRead;
			rototype.onTckStatusChanged = onTckStatusChanged;
			rototype.onTicketPrint = onTicketPrint;
			rototype.onReceiptStatusChanged = onReceiptStatusChanged;
			rototype.onReceiptPrint = onReceiptPrint;
			rototype.onLightsStatusChanged = onLightsStatusChanged;

			rototype.connect("ws://rototypedyn.dyndns.org:5846/xfs4iot/v1.0");
		}

		function doDisconnect() {
			if (rototype)
				rototype.close()
		}

		function doGetServices() {
			if (rototype)
				rototype.getServices()
		}

		function doClearLog() {
			document.getElementById('log').innerHTML = '';
		}

		function doBarcodeReset() {
			if (rototype)
				rototype.barcodeReset();
		}

		function doBarcodeRead() {
			if (rototype)
				rototype.barcodeRead();
		}

		function doBarcodeTest() {
			if (rototype)
				rototype.barcodeTest();
		}

		function doNFCReset() {
			if (rototype)
				rototype.nfcReset();
		}

		function doNFCRead() {
			if (rototype)
				rototype.nfcRead();
		}

		function doNFCTest() {
			if (rototype)
				rototype.nfcTest();
		}

		function doTckReset() {
			if (rototype)
				rototype.tckReset();
		}

		function doTckPrintRaw() {
			if (rototype)
			rototype.tckPrintRaw("<LHT650,416,-16,0><RC20,20><B2Dn,A,0><B2Dn,B,7><B2Dn,C,0><B2Dn,D,0><B2Dn,P,14,19J4Q0DSGP2PFR><RC10,180><F3><HW1,1>19J4Q0DSGP2PFR<F:enc:utf-8><F:trado.ttf><F:size:14><RC90,180>Test ticket & 20%<X2,H><RC200,20><NCP10,16>{B19J4Q0DSGP2PFR<F:clear><p>", false);
//				rototype.tckPrintRaw("<RC45,450><B2Dn,A,0><B2Dn,B,7><B2Dn,C,0><B2Dn,D,0><B2Dn,P,[1234567890 10],1234567890><F:vera.ttf><F:size:10><RC205,20>Test ticket<F:vera.ttf><F:size:10><RC355,20>Valid until:<RC355,190>10/12/2022<F:vera.ttf><F:size:10><RC255,20>100,00 USD<RC260,470>100,00 $<F:vera.ttf><F:size:8><RC405,180>1234567890<PP7,432,195,0><PP6,480,340,0><PP5,110,305,0><PP4,345,255,0>", false);
//				<RC100,200><F2><HW4,2>VGS test ticket<RC200,250><oP18><X3>^VGS^<p>", false);
		}

		function doTckTest() {
			if (rototype)
				rototype.tckTest("<LHT650,416,-16,0><RC20,20><B2Dn,A,0><B2Dn,B,7><B2Dn,C,0><B2Dn,D,0><B2Dn,P,14,19J4Q0DSGP2PFR><RC10,180><F3><HW1,1>19J4Q0DSGP2PFR<F:enc:utf-8><F:trado.ttf><F:size:14><RC90,180>Test ticket & 20%<X2,H><RC200,20><NCP10,16>{B19J4Q0DSGP2PFR<F:clear><p>");
		}

		function doReceiptReset() {
			if (rototype)
				rototype.receiptReset();
		}

		function doReceiptPrintForm() {
			if (rototype) {
				let message = {
					timeout: 10000, 
					formName: "VGSRototypeReceipt",
					mediaName:"VGSRototypeReceipt",
					alignment: "formDefinition",
					fields: {
							ReceiptHeader: "VGS Rototype Sample Receipt",
							ReceiptText: "PNR                 : VWAK7VST\nUser                : Support, VGS        \nDATE/TIME           : 20/07/2022 - 17:35 \nWORKSTATION         : WKS-Drome\nTYPE                : Normal\nTRANSACTION         : T:1000.2.220720.46  \n================================================\nCheese bacon burger\n                  1 x     5.20 =         €  5.20\nPizza Napoli\n                  1 x     5.50 =         €  5.50\nFanta\n (Small 2.50 included)\n                  2 x     2.50 =         €  5.00\nFranziskaner\ndescription Franzi\n                  2 x     5.00 =         € 10.00\n7up\n (Large 4.50 included)\n                  1 x     4.50 =         €  4.50\n                                      __________\n                           TOTAL         € 30.20\n================================================\n                       SUB TOTAL         € 29.41\n                           Iva 4%        €  0.79\n================================================\n                            Cash         € 30.20\n                                      __________\n                        TENDERED         € 30.20\n                         BALANCE          € 0.00\n================================================\n                     PNR: VWAK7VST\n             WORKSTATION: WKS-Drome\n               DATE/TIME: 20/07/2022 - 17:35\n                    TYPE: Normal\n                T:1000.2.220720.46\n                ",
							Barcode: "www.vgs.com"
					},
					mediaControl: {
						expel: true
					}
				};
				rototype.receiptPrintForm(message);
			}
		}

		function doReceiptLoadDef() {
			if (rototype)
				rototype.receiptLoadDefinition("VGSRototypeReceipt");
		}

		function doLightsSet() {
			if (rototype) {
				let message = {
					timeout: 1000, 
					ticketprinter: {
      			flashRate: "continuous",
      			color: "red"
   				},
					nfccreditcard: {
      			flashRate: "medium",
      			color: "blue"
   				}
				};
				rototype.lightsSet(message);
			}
		}

		function doLightsOff() {
			if (rototype) {
				let message = {
					timeout: 1000, 
					ticketprinter: {
      			flashRate: "off"
   				},
					nfccreditcard: {
      			flashRate: "off"
   				}
				};
				rototype.lightsSet(message);
			}
		}

		function onBarcodeStatusChanged(status) {
			$("#barcode-device-status").html(status.common.device);
			$("#barcode-scanner-status").html(status.barcodeReader.scanner);
		}

		function onBarcodeRead(read) {
			if (read.completionCode === "success")
				$("#barcode-last-read").html(read.barcodeData);
			else
				$("#barcode-last-read").html(read.errorDescription);
		}

		function onNFCStatusChanged(status) {
			$("#nfc-device-status").html(status.common.device);
			$("#nfc-scanner-status").html(status.barcodeReader.scanner);
		}

		function onNfcRead(read) {
			if (read.completionCode === "success")
				$("#nfc-last-read").html(read.barcodeData);
			else
				$("#nfc-last-read").html(read.errorDescription);
		}

		function onTckStatusChanged(status) {
			$("#tck-status").html(status.common.device);
			$("#tck-paper-status").html(status.printer.paper);
		}

		function onTicketPrint(event) {
			if (event.completionCode === "success")
				$("#tck-last-print").html(event.completionCode);
			else
				$("#tck-last-print").html(event.errorDescription);
		}

		function onReceiptStatusChanged(status) {
			$("#receipt-status").html(status.common.device);
			$("#receipt-paper-status").html(status.printer.paper);
		}

		function onReceiptPrint(event) {
			if (event.completionCode === "success")
				$("#receipt-last-print").html(event.completionCode);
			else
				$("#receipt-last-print").html(event.errorDescription);
		}

		function onLightsStatusChanged(status) {
			$("#lights-status").html(status.common.device);
		}

		(function () {
			var old = console.log;
			let logger = $("#log");
			console.log = function (message) {
				if (typeof message == 'object')
					logger.text(logger.text() +  (JSON && JSON.stringify ? JSON.stringify(message) : message) + "\n");
				else 
					logger.text(logger.text() + message + "\n");
			}
		})();
	</script>
</body>

</html>