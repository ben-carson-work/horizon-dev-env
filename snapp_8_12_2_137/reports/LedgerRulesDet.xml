<?xml version="1.0" encoding="UTF-8" standalone="no"?><DOEnt_DocTemplate><Header><EntityType>37</EntityType><EntityId>A6BF9B3F-268B-3B0A-0014-0153E1494C3C</EntityId><LastUpdate>2023-03-02T16:58:00.000+0100</LastUpdate></Header><DocTemplate><IconName>rpt-dataexport.png</IconName><EntityType>37</EntityType><DocTemplateId>A6BF9B3F-268B-3B0A-0014-0153E1494C3C</DocTemplateId><DocTemplateName>@Stats.LedgerRulesDet</DocTemplateName><DocTemplateCode>DOC45</DocTemplateCode><CategoryId>B49F9C2B-BD9A-C3BB-0095-014E014DC845</CategoryId><DocEnabled>true</DocEnabled><ExecRequireLogin>true</ExecRequireLogin><DocTemplateType>5</DocTemplateType><DocEditorType>6</DocEditorType><SystemCode>LedgerRulesDet</SystemCode><DocContexts/><SaleForApproval>false</SaleForApproval><SaleOpen>false</SaleOpen><SalePaid>false</SalePaid><SaleCompleted>false</SaleCompleted><IndividualPAH>false</IndividualPAH><LogCount>2</LogCount><DataSourceSelection>false</DataSourceSelection><DataSourceId/><MaxDateRangeDays/><MediaEncoderPluginId/><ProductDocumentTagIDs/><MediaRfidOptionType/><DataSourceList><DataSource><Name>Default</Name><Code>TV3CA8BW6VPG232</Code><SQL unescaped="true"><![CDATA[select
  /********************************** TRIGGER SECTION **********************************/
  (select ItemName from tbLookupItem LI where TableCode=353 and LI.ItemCode=LR.LedgerRuleStatus) as [LedgerRuleStatus],
  LR.LedgerRuleId,
  LR.TriggerEntityType,
  (select ItemName from tbLookupItem LI where TableCode=131 and LI.ItemCode=LR.TriggerEntityType) as [TriggerEntityTypeName],
  LR.TriggerEntityId,
  P.ProductCode,
  P.ProductName,
  LR.LedgerTriggerType as [TriggerType],
  (select ItemName from tbLookupItem LI where TableCode=183 and LI.ItemCode = LR.LedgerTriggerType) as [TriggerTypeName],
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=1), 0) as TriggerOnRefund,
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=2), 0) as TriggerOnUpgrade,
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=7), 0) as [TriggerValidOnlineOffline],
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=8), 0) as [TriggerInvalidOffline],
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=5), 0) as [TriggerUsedTickets],
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=6), 0) as [TriggerUnusedTickets],
  /********************************** FILTER SECTION **********************************/
  Coalesce((select top(1) Value from tbLedgerRuleFilter where LedgerRuleFilterType=10 and LedgerRuleId=LR.LedgerRuleId), '-') as [TriggerWorkstationType],
  Coalesce(dbo.fnLookupItemDesc(19, (select top(1) Value from tbLedgerRuleFilter where LedgerRuleFilterType=10 and LedgerRuleId=LR.LedgerRuleId)), '-') as [TriggerWorkstationTypeName],
  Coalesce((select top(1) Value from tbLedgerRuleFilter where LedgerRuleFilterType=20 and LedgerRuleId=LR.LedgerRuleId), '-') as [TriggerLocationId],
  Coalesce((
    select top(1) 
	  A.DisplayName
	from 
	  tbLedgerRuleFilter LRF inner join
	  tbAccount A on A.AccountId=LRF.Value
	where 
	  LedgerRuleFilterType=20 and 
	  LedgerRuleId=LR.LedgerRuleId), '-') as [TriggerLocationName],
  Coalesce((select top(1) Value from tbLedgerRuleFilter where LedgerRuleFilterType=30 and LedgerRuleId=LR.LedgerRuleId), '-') as [TriggerWorkstationType],
  Coalesce(dbo.fnLookupItemDesc(19, (select top(1) Value from tbLedgerRuleFilter where LedgerRuleFilterType=30 and LedgerRuleId=LR.LedgerRuleId)), '-') as [TriggerWorkstationTypeName],
  Coalesce((select top(1) Value from tbLedgerRuleFilter where LedgerRuleFilterType=40 and LedgerRuleId=LR.LedgerRuleId), '-') as [TriggerSaleLocationId],
  Coalesce((
    select top(1) 
	  A.DisplayName
	from 
	  tbLedgerRuleFilter LRF inner join
	  tbAccount A on A.AccountId=LRF.Value
	where 
	  LedgerRuleFilterType=40 and 
	  LedgerRuleId=LR.LedgerRuleId), '-') as [TriggerSaleLocationName],
  /********************************** VALUE SECTION **********************************/
  LR.LedgerRuleAmount,
  LR.LedgerRuleAmountType,
  (select ItemName from tbLookupItem LI where TableCode=181 and LI.ItemCode = LR.LedgerRuleAmountType) as [LedgerRuleAmountTypeName],
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=4), 0) as AffectClearingLimit,
  /********************************** DETAILS SECTION **********************************/ 
  Coalesce(CONVERT(varchar(max), LRD.DebitLedgerAccountId), '-') as DebitLedgerAccountId,
  Coalesce(LAD.LedgerAccountCode, '-') as [DebitLedgerAccountCode],
  Coalesce(LAD.LedgerAccountName, '-') as [DebitLedgerAccountName],
  Coalesce(Cast(LRD.DebitAccountType as varchar(max)), '-') as [DebitAccountType],
  (case when LRD.DebitAccountType is null then '-' else (select ItemName from tbLookupItem LI where TableCode=182 and LI.ItemCode = LRD.DebitAccountType) end) as [DebitAccountTypeName],
  Coalesce(CONVERT(varchar(max), LRD.DebitAccountId), '-') as [DebitAccountId],
  Coalesce(AD.DisplayName, '-') as [DebitAccountName],
  Coalesce(CONVERT(varchar(max), LRD.CreditLedgerAccountId), '-') as [CreditLedgerAccountId],
  Coalesce(LAC.LedgerAccountCode, '-') as [CreditLedgerAccountCode],
  Coalesce(LAC.LedgerAccountName, '-') as [CreditLedgerAccountName],
  Coalesce(CONVERT(varchar(max), LRD.CreditAccountType), '-') as [CreditAccountType],
  (case when LRD.CreditAccountType is null then '-' else (select ItemName from tbLookupItem LI where TableCode=182 and LI.ItemCode = LRD.CreditAccountType) end) as [CreditAccountTypeName],  
  Coalesce(CONVERT(varchar(max), LRD.CreditAccountId), '-') as [CreditAccountId],
  Coalesce(AC.DisplayName, '-') as [CreditAccountName],
  LRD.Weight,
  LRD.WeightType,
  (select ItemName from tbLookupItem LI where TableCode=340 and LI.ItemCode = LRD.WeightType) as [WeightTypeName],
  Coalesce(CONVERT(varchar(max), LRD.UsageFilterLocationId), '-') as [UsageFilterLocationId],
  Coalesce(LTUF.DisplayName, '-') as [UsageFilterLocationName],
  Coalesce((select 1 from tbLedgerRuleFlag LRF where LRF.LedgerRuleId=LR.LedgerRuleId and LRF.LedgerRuleFlag=9), 0) as [MultiplyEntries]
from 
  tbLedgerRule LR left join
  tbLedgerRuleDetail LRD on LRD.LedgerRuleId=LR.LedgerRuleId left join
  tbProduct P on P.ProductId=LR.TriggerEntityId left join
  tbLedgerAccount LAD on LAD.LedgerAccountId=LRD.DebitLedgerAccountId left join
  tbLedgerAccount LAC on LAC.LedgerAccountId=LRD.CreditLedgerAccountId left join
  tbAccount AD on AD.AccountId=LRD.DebitAccountId left join
  tbAccount AC on AC.AccountId=LRD.CreditAccountId left join
  tbAccount LTUF on LTUF.AccountId=LRD.UsageFilterLocationId
union
/********************************** PAYMENT METHODS HAVE QUICK RULE SELECTION **********************************/
select
  'unknown' as LedgerRuleStatus,
  Coalesce(CONVERT(varchar(max), PPM.PluginId), '-') as [LedgerRuleId],
  1004 as [TriggerEntityType],
  'Payment Method' as [TriggerEntityTypeName],
  Coalesce(CONVERT(varchar(max), PPM.PluginId), '-') as [TriggerEntityId],
  NULL as [P.ProductCode],
  NULL as [ProductName],
  101 as [TriggerType],
  'Sale' as [TriggerTypeName],
  0 as TriggerOnRefund,
  0 as TriggerOnUpgrade,
  0 as [TriggerValidOnlineOffline],
  0 as [TriggerInvalidOffline],
  0 as [TriggerUsedTickets],
  0 as [TriggerUnusedTickets],
  '-' as [TriggerWorkstationType],
  '-' as [TriggerWorkstationTypeName], 
  '-' as [TriggerLocationId],
  '-' as [TriggerLocationName],
  '-' as [TriggerSaleWorkstationType],
  '-' as [TriggerSaleWorkstationTypeName],
  '-' as [TriggerSaleLocationId],
  '-' as [TriggerSaleLocationName],
  100.00 as [LedgerRuleAmount],
  20 as [LedgerRuleAmountType],
  'Percentage of gross price' as [LedgerRuleAmountType],
  0 as [AffectClearingLimit],
  Coalesce(CONVERT(varchar(max), PPM.DebitLedgerAccountId), '-') as [DebitLedgerAccountId],
  Coalesce(LAD.LedgerAccountCode, '-') as [DebitLedgerAccountCode],
  Coalesce(LAD.LedgerAccountName, '-') as [DebitLedgerAccountName],
  2 as [DebitAccountType],
  'Sale location' as [DebitAccountTypeName],
  '-' as [DebitLocationId],
  '-' as [DebitLocationName],
  Coalesce(CONVERT(varchar(max), PPM.CreditLedgerAccountId), '-') as [CreditLedgerAccountId],
  Coalesce(LAC.LedgerAccountCode, '-') as [CreditLedgerAccountCode],
  Coalesce(LAC.LedgerAccountName, '-') as [CreditLedgerAccountName],
  2 as [CreditAccountType],
  'Sale location' as [CreditAccountTypeName],
  '-' as [CreditAccountId],
  '-' as [CreditAccountName],
  100.00 as [Weight],
  2 as [WeightType],
  'Percentage' as [WeightTypeName],
  '-' as [UsageFilterLocationId],
  '-' as [UsageFilterLocationName],
  0 as [MultiplyEntries]
from 
  tbPluginPaymentMethod PPM left join
  tbLedgerAccount LAD on LAD.LedgerAccountId=PPM.DebitLedgerAccountId left join
  tbLedgerAccount LAC on LAC.LedgerAccountId=PPM.CreditLedgerAccountId 
where 
  PPM.DebitLedgerAccountId is not null or
  PPM.CreditLedgerAccountId is not null]]></SQL></DataSource></DataSourceList><RightList><Right><IconName>station.png</IconName><UsrEntityType>3</UsrEntityType><UsrEntityId>D208061D-5711-9CD4-002F-014E014DC7E1</UsrEntityId><UsrEntityCode>BKOFFICE</UsrEntityCode><UsrEntityName>Back Office</UsrEntityName><RightLevel>5</RightLevel></Right><Right><IconName>account_prs.png</IconName><UsrEntityType>15</UsrEntityType><UsrEntityId>A0000131-0000-0000-0000-000000000015</UsrEntityId><UsrEntityCode/><UsrEntityName>Every user</UsrEntityName><RightLevel>5</RightLevel></Right></RightList></DocTemplate></DOEnt_DocTemplate>